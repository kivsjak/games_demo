<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moooon 1:1 Exact Replica</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Градієнти кульок */
            --grad-1x: linear-gradient(135deg, #aed581 0%, #7cb342 100%);
            --grad-2x: linear-gradient(135deg, #80cbc4 0%, #26a69a 100%);
            --grad-10x: linear-gradient(135deg, #90caf9 0%, #42a5f5 100%);
            --grad-20x: linear-gradient(135deg, #b39ddb 0%, #7e57c2 100%);
            --grad-50x: linear-gradient(135deg, #f48fb1 0%, #ec407a 100%);
            --grad-300x: linear-gradient(135deg, #ffab91 0%, #ff7043 100%);
            
            /* Кольори світіння */
            --glow-1x: #7cb342;
            --glow-2x: #26a69a;
            --glow-10x: #42a5f5;
            --glow-20x: #7e57c2;
            --glow-50x: #ec407a;
            --glow-300x: #ff7043;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background: #0d0416;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Fredoka', sans-serif;
            overflow: hidden;
        }

        #game-frame {
            position: relative;
            width: 100%;
            max-width: 1600px;
            aspect-ratio: 16/9;
            background: radial-gradient(circle at 50% 30%, #3e2063 0%, #1a0b2e 80%);
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            color: white;
        }

        @media (min-aspect-ratio: 16/9) {
            #game-frame { height: 95vh; width: auto; }
        }
        @media (max-aspect-ratio: 16/9) {
            #game-frame { width: 95vw; height: auto; }
        }

        /* --- BACKGROUND --- */
        .stars-container {
            position: absolute;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
            animation: starScroll 10s linear infinite;
        }

        .bg-cloud {
            position: absolute;
            background: radial-gradient(circle, rgba(244, 143, 177, 0.15) 0%, rgba(244, 143, 177, 0) 70%);
            border-radius: 50%;
            filter: blur(20px);
            z-index: 0;
            animation: floatCloud 20s linear infinite alternate;
        }

        @keyframes starScroll {
            from { transform: translateY(-10vh); }
            to { transform: translateY(110vh); }
        }

        @keyframes floatCloud {
            from { transform: translateX(-5%) translateY(0); }
            to { transform: translateX(5%) translateY(5%); }
        }

        /* --- SPEED LINES --- */
        .speed-lines-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .speed-lines-container.active { opacity: 1; }
        .speed-line {
            position: absolute;
            width: 2px;
            background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.8), transparent);
            top: -50vh; 
        }

        #game-frame.hyperspace .star {
            animation: warpSpeed 0.3s linear infinite;
            width: 2px !important;
            height: 50vh !important;
            opacity: 0.5;
            box-shadow: 0 0 10px white;
        }

        @keyframes warpSpeed {
            0% { transform: translateY(-50vh); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(150vh); opacity: 0; }
        }

        /* UI ELEMENTS */
        .cloud-container {
            position: absolute;
            top: 15%;
            right: 5%;
            width: 22%; 
            z-index: 5;
        }
        .cloud-svg { width: 100%; filter: drop-shadow(0 0.5vw 1.5vw rgba(0,0,0,0.3)); overflow: visible; }
        
        .sign-group {
            position: absolute;
            top: -25%; left: 55%;
            transform: translateX(-50%) rotate(-6deg);
            width: 65%;
            z-index: 10; 
        }
        .sign-board {
            background: #fbe9e7;
            border: 0.15vw solid #d7ccc8;
            padding: 0.4vw 0;
            border-radius: 0.4vw;
            color: #3e2723;
            box-shadow: 0.2vw 0.4vw 0 rgba(0,0,0,0.2);
            text-align: center;
            position: relative;
        }
        .sign-board::after {
            content: ''; position: absolute; bottom: -120%; left: 50%; width: 12%; height: 130%;
            background: #5d4037; transform: translateX(-50%); z-index: -1; 
        }
        .sign-title { font-size: 1.6vw; font-weight: 800; line-height: 1; }
        .sign-sub { font-size: 0.9vw; font-weight: 700; opacity: 0.7; margin-top: 0.1vw; }

        /* --- GAME AREA (Fixed Layout) --- */
        .game-area {
            flex: 1;
            position: relative;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 24%; 
            padding-left: 0; 
        }

        .lanes-grid {
            display: flex;
            align-items: flex-end;
            gap: 1.5vw;
            height: 100%;
            padding-top: 10%;
        }

        .separator { width: 3vw; }

        .lane-col {
            position: relative;
            width: 4.5vw;
            height: 100%;
        }

        /* Трек */
        .lane-col::before {
            content: '';
            position: absolute;
            bottom: -5.5vw; left: 50%;
            width: 3.5vw;
            height: 65vh;
            background: linear-gradient(to bottom, transparent 0%, rgba(255,255,255,0.05) 100%);
            transform: translateX(-50%);
            border-radius: 2vw;
            z-index: -1;
        }

        /* --- BUBBLES --- */
        .bubbles-container {
            position: absolute;
            width: 100%;
            bottom: 0; 
            height: 150vh; 
            left: 0;
            pointer-events: none; 
        }

        .bubble {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 4.5vw;
            height: 4.5vw;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            font-size: 1.3vw;
            color: white;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
            z-index: 2; 
            transition: opacity 0.2s, transform 0.2s; /* Додав transform для плавної появи при Refresh */
            transform-origin: center center; 
        }
        
        /* Клас для анімації появи при Refresh */
        .bubble.pop-in {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: translateX(-50%) scale(0); } to { transform: translateX(-50%) scale(1); } }

        .bubble::after {
            content: ''; position: absolute; top: 10%; left: 15%; width: 30%; height: 20%;
            border-radius: 50%; background: rgba(255,255,255,0.7); filter: blur(2px); transform: rotate(-45deg);
        }

        .bubble.blur-move {
            filter: blur(3px);
            transform: translateX(-50%) scaleY(1.3);
        }

        .b-1x { background: radial-gradient(circle at 30% 30%, #dcedc8, var(--glow-1x)); box-shadow: 0 0 1.5vw var(--glow-1x), inset 0 0 1vw rgba(255,255,255,0.5); }
        .b-2x { background: radial-gradient(circle at 30% 30%, #b2dfdb, var(--glow-2x)); box-shadow: 0 0 1.5vw var(--glow-2x), inset 0 0 1vw rgba(255,255,255,0.5); }
        .b-10x { background: radial-gradient(circle at 30% 30%, #bbdefb, var(--glow-10x)); box-shadow: 0 0 1.5vw var(--glow-10x), inset 0 0 1vw rgba(255,255,255,0.5); }
        .b-20x { background: radial-gradient(circle at 30% 30%, #d1c4e9, var(--glow-20x)); box-shadow: 0 0 1.5vw var(--glow-20x), inset 0 0 1vw rgba(255,255,255,0.5); }
        .b-50x { background: radial-gradient(circle at 30% 30%, #f8bbd0, var(--glow-50x)); box-shadow: 0 0 1.5vw var(--glow-50x), inset 0 0 1vw rgba(255,255,255,0.5); }
        .b-300x { background: radial-gradient(circle at 30% 30%, #ffccbc, var(--glow-300x)); box-shadow: 0 0 1.5vw var(--glow-300x), inset 0 0 1vw rgba(255,255,255,0.5); }

        .lane-arrow {
            position: absolute;
            bottom: -5.5vw; 
            left: 50%;
            transform: translateX(-50%);
            width: 4.5vw;
            height: 4.5vw;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: 0.15vw solid rgba(255,255,255,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 1; 
            transition: transform 0.1s;
        }
        .lane-arrow:hover { background: rgba(255,255,255,0.25); transform: translateX(-50%) scale(1.05); }
        .lane-arrow svg { width: 50%; fill: rgba(255,255,255,0.7); }

        /* --- CHARACTER --- */
        #character-wrap {
            position: absolute;
            bottom: calc(14% + 25px);
            left: 50%;
            transform: translateX(-50%); /* Центрування */
            width: 8vw;
            height: 8vw;
            z-index: 20;
            transition: left 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94), filter 0.2s ease, transform 0.1s;
        }
        #character-wrap svg { animation: hovering 2s ease-in-out infinite; transition: transform 0.1s; }
        #character-wrap.absorbing svg { transform: scale(1.3); }
        @keyframes hovering { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-0.6vw); } }

        /* --- CONTROLS PANEL --- */
        .controls-wrapper {
            position: absolute;
            bottom: 2%; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            width: 28%;
        }
        .panel-bg {
            background: #332219; border-radius: 1.5vw; padding: 1vw 1.2vw;
            display: flex; flex-direction: column; gap: 0.8vw;
            box-shadow: 0 1vw 2vw rgba(0,0,0,0.6); border: 0.15vw solid #523c2e; height: auto;
        }
        .bet-row { display: flex; justify-content: space-between; align-items: flex-end; width: 100%; padding: 0 0.5vw; }
        .bet-group { display: flex; flex-direction: column; align-items: center; }
        .bet-label { font-size: 0.7vw; color: #bebdb8; font-weight: 800; margin-bottom: 0.3vw; text-transform: uppercase; letter-spacing: 0.05vw; }
        .symbol-btn { background: none; border: none; color: #bebdb8; font-size: 2vw; font-weight: 900; cursor: pointer; padding: 0; line-height: 1; height: 2vw; display: flex; align-items: center; transition: transform 0.1s; }
        .symbol-btn:active { transform: scale(0.9); color: white; }
        .input-pill { background: #e6dac7; border-radius: 0.8vw; height: 2.8vw; width: 12vw; display: flex; justify-content: space-between; align-items: center; padding: 0 0.5vw; box-shadow: inset 0 0.2vw 0.4vw rgba(0,0,0,0.1); }
        .pill-btn { background: none; border: none; font-size: 0.9vw; font-weight: 700; color: #594d42; cursor: pointer; padding: 0 0.4vw; }
        .pill-btn:hover { color: #2b1808; }
        .bet-value { font-size: 1.2vw; font-weight: 800; color: #382e25; }
        .actions-row { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-top: 0.2vw; }
        .btn-3d { border: none; border-radius: 50%; color: white; font-weight: 700; cursor: pointer; position: relative; display: flex; justify-content: center; align-items: center; transition: top 0.1s, box-shadow 0.1s; }
        .btn-3d:active { top: 0.3vw; box-shadow: none !important; }
        .btn-purple { width: 3.2vw; height: 3.2vw; font-size: 1.6vw; background: linear-gradient(to bottom, #9c6ade, #7a46b5); box-shadow: 0 0.3vw 0 #4a2c66; border: 0.15vw solid #6e4494; }
        .btn-orange { width: 3.2vw; height: 3.2vw; font-size: 1.4vw; background: linear-gradient(to bottom, #ea7d27, #c45d0f); box-shadow: 0 0.3vw 0 #8f4209; border: 0.15vw solid #b05713; }
        .btn-blue { border-radius: 0.8vw; height: 3.2vw; width: 10vw; font-size: 1.4vw; font-family: 'Fredoka', sans-serif; font-weight: 800; text-transform: uppercase; background: linear-gradient(to bottom, #29aae1, #1c85b5); box-shadow: 0 0.3vw 0 #105a7d; border: 0.15vw solid #1e7ba3; text-shadow: 0 0.1vw 0.1vw rgba(0,0,0,0.2); }

        .tooltip-box {
            position: absolute; bottom: 0.5vw; left: 50%; transform: translateX(-50%) translateY(0);
            background: #221606; padding: 0.8vw 1.2vw; border-radius: 0.6vw; border-left: 0.3vw solid #a1887f; width: 11vw;
            box-shadow: 0 1vw 2vw rgba(0,0,0,0.5); z-index: 200; pointer-events: none; opacity: 0; transition: opacity 0.3s, transform 0.3s;
        }
        .tooltip-box.active { opacity: 1; transform: translateX(-50%) translateY(0); }
        .tooltip-box::after { content: ''; position: absolute; left: 50%; bottom: -0.5vw; transform: translateX(-50%); border-width: 0.5vw 0.5vw 0 0.5vw; border-style: solid; border-color: #221606 transparent transparent transparent; }
        .tt-row { display: flex; justify-content: space-between; font-size: 0.9vw; margin-bottom: 0.3vw; }
        .tt-label { color: #bdbdbd; font-weight: 600; }
        .tt-val { color: #fff; font-weight: 700; }

    </style>
</head>
<body>

    <div id="game-frame">
        <div class="stars-container" id="star-container"></div>
        <div class="speed-lines-container" id="speed-lines"></div>
        <div class="bg-cloud" style="width: 30vw; height: 30vw; top: 10%; left: 10%;"></div>
        <div class="bg-cloud" style="width: 40vw; height: 40vw; top: 40%; right: -10%; animation-delay: -5s;"></div>
        
        <div class="cloud-container">
            <svg class="cloud-svg" viewBox="0 0 220 140">
                <defs>
                    <linearGradient id="cloudGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#f8bbd0;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#f48fb1;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <g fill="url(#cloudGrad)">
                    <circle cx="50" cy="80" r="40" />
                    <circle cx="90" cy="60" r="50" />
                    <circle cx="140" cy="70" r="45" />
                    <circle cx="180" cy="90" r="35" />
                    <circle cx="110" cy="100" r="40" />
                    <circle cx="60" cy="110" r="30" />
                </g>
                <circle cx="70" cy="50" r="10" fill="white" opacity="0.2"/>
                <circle cx="120" cy="40" r="15" fill="white" opacity="0.2"/>
                <circle cx="160" cy="60" r="8" fill="white" opacity="0.2"/>
            </svg>
            <div class="sign-group">
                <div class="sign-board">
                    <div class="sign-title">Moooon</div>
                    <div class="sign-sub">382 000 km</div>
                </div>
            </div>
        </div>

        <div class="game-area">
            <div id="character-wrap">
                <svg viewBox="0 0 100 100" style="width: 100%; height: 100%; filter: drop-shadow(0 0.4vw 0.4vw rgba(0,0,0,0.3));">
                    <g transform="translate(15, 20)">
                        <rect x="15" y="25" width="40" height="35" rx="10" fill="#c62828" />
                        <path d="M20,55 L20,70 L25,70 L25,55" fill="#3e2723"/>
                        <path d="M45,55 L45,70 L50,70 L50,55" fill="#3e2723"/>
                        <path d="M10,15 H60 V50 H10 Z" fill="#e57373" rx="8" style="fill:#ef5350; stroke:#b71c1c; stroke-width:2; stroke-linejoin:round;"/>
                        <rect x="10" y="15" width="50" height="35" rx="8" fill="#ef5350" />
                        <path d="M10,20 Q-5,10 5,-5 L12,15" fill="white" stroke="#cfd8dc" stroke-width="1"/>
                        <path d="M60,20 Q75,10 65,-5 L58,15" fill="white" stroke="#cfd8dc" stroke-width="1"/>
                        <circle cx="25" cy="30" r="6" fill="white"/>
                        <circle cx="25" cy="30" r="2" fill="black"/>
                        <circle cx="45" cy="30" r="6" fill="white"/>
                        <circle cx="45" cy="30" r="2" fill="black"/>
                        <path d="M18,25 L32,25" stroke="#3e2723" stroke-width="2"/>
                        <path d="M38,25 L52,25" stroke="#3e2723" stroke-width="2"/>
                        <rect x="25" y="40" width="20" height="8" rx="4" fill="#3e2723"/>
                        <circle cx="29" cy="44" r="1.5" fill="#a1887f"/>
                        <circle cx="41" cy="44" r="1.5" fill="#a1887f"/>
                    </g>
                </svg>
            </div>
            <div class="lanes-grid" id="lanes"></div>
        </div>

        <div class="controls-wrapper">
            <div class="panel-bg">
                <div class="bet-row">
                    <div class="bet-group">
                        <div class="bet-label">MIN</div>
                        <button class="symbol-btn" onclick="updateBet(-1)">−</button>
                    </div>
                    <div class="bet-group">
                        <div class="bet-label">BET AMOUNT</div>
                        <div class="input-pill">
                            <button class="pill-btn" onclick="updateBet(0, 0.5)">½</button>
                            <div class="bet-value" id="bet-display">$10.00</div>
                            <button class="pill-btn" onclick="updateBet(0, 2)">2x</button>
                        </div>
                    </div>
                    <div class="bet-group">
                        <div class="bet-label">MAX</div>
                        <button class="symbol-btn" onclick="updateBet(1)">+</button>
                    </div>
                </div>
                <div class="actions-row">
                    <button class="btn-3d btn-purple">?</button>
                    <button class="btn-3d btn-blue" id="refresh-btn">REFRESH</button>
                    <button class="btn-3d btn-orange">»</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const laneColors = { 1: '#7cb342', 2: '#26a69a', 3: '#42a5f5', 4: '#7e57c2', 5: '#ec407a', 6: '#ff7043' };
        const lanesConfig = [
            { id: 1, val: 1.1, cls: 'b-1x' }, { id: 2, val: 2, cls: 'b-2x' }, { id: 3, val: 10, cls: 'b-10x' },
            { id: 'sep' }, 
            { id: 4, val: 20, cls: 'b-20x' }, { id: 5, val: 50, cls: 'b-50x' }, { id: 6, val: 300, cls: 'b-300x' } 
        ];

        const lanesContainer = document.getElementById('lanes');
        const charWrap = document.getElementById('character-wrap');
        const gameFrame = document.getElementById('game-frame');
        let currentBet = 10.00;
        let selectedLaneIndex = 0; 
        let tooltipEl = null;
        let isAnimating = false; // Блокування натискань під час анімації

        const starContainer = document.getElementById('star-container');
        for(let i=0; i<50; i++) {
            const s = document.createElement('div');
            s.className = 'star';
            s.style.top = Math.random()*100 + '%';
            s.style.left = Math.random()*100 + '%';
            const size = Math.random()*0.3 + 0.1;
            s.style.width = size + 'vw';
            s.style.height = size + 'vw';
            s.style.animationDuration = (8 + Math.random()*10) + 's';
            s.style.animationDelay = (Math.random()*-20) + 's';
            starContainer.appendChild(s);
        }

        function init() {
            createTooltip();
            initLanesStructure();
            // Start at center initially (center of screen, not specific lane)
            moveBullToCenter();
        }

        function createTooltip() {
            tooltipEl = document.createElement('div');
            tooltipEl.className = 'tooltip-box';
            tooltipEl.innerHTML = `<div class="tt-row"><span class="tt-label">Total Bets</span><span class="tt-val">x10</span></div><div class="tt-row"><span class="tt-label">Win per Bet</span><span class="tt-val">$11</span></div>`;
        }

        function initLanesStructure() {
            regenerateBoard(); // Initial generation with random gaps
        }

        // Перегенерувати сітку (для Refresh або ініціалізації)
        function regenerateBoard() {
            lanesContainer.innerHTML = '';
            let logicalIndex = 0;
            lanesConfig.forEach((lane) => {
                if (lane.id === 'sep') {
                    const sep = document.createElement('div');
                    sep.className = 'separator';
                    lanesContainer.appendChild(sep);
                    return;
                }
                const col = document.createElement('div');
                col.className = 'lane-col';
                col.id = `lane-${lane.id}`;
                col.dataset.index = logicalIndex;
                col.dataset.configId = lane.id;
                
                const bubbleContainer = document.createElement('div');
                bubbleContainer.className = 'bubbles-container';
                col.appendChild(bubbleContainer);

                const arrow = document.createElement('div');
                arrow.className = 'lane-arrow';
                arrow.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 4l-8 8h6v8h4v-8h6z" /></svg>`;
                arrow.onclick = () => handleLaneClick(col.dataset.index, arrow, col);
                col.appendChild(arrow);

                // Спавн 5 кульок з вірогідністю дірок
                for(let i=0; i<5; i++) { 
                    if(Math.random() > 0.3) { // 30% шанс дірки
                        createStaticBubble(bubbleContainer, lane, i); 
                    }
                }
                lanesContainer.appendChild(col);
                logicalIndex++;
            });
        }

        function createStaticBubble(container, lane, index) {
            const b = document.createElement('div');
            b.className = `bubble ${lane.cls} pop-in`; // Add animation class
            b.innerText = lane.val + 'x';
            b.style.bottom = `${index * 5.7}vw`; 
            b.style.opacity = '1';
            b.style.transform = 'translateX(-50%)'; 
            b.style.top = 'auto'; 
            container.appendChild(b);
        }

        // Логіка польоту (клік по стрілці)
        function playLaneAction(targetLaneIndex) {
            let targetConfig = null;
            let logicalIndex = 0;
            
            for(let lane of lanesConfig) {
                if(lane.id === 'sep') continue;
                if(logicalIndex === targetLaneIndex) {
                    targetConfig = lane;
                    break;
                }
                logicalIndex++;
            }

            if(!targetConfig) return;

            const col = document.getElementById(`lane-${targetConfig.id}`);
            if(!col) return;
            const bubbleContainer = col.querySelector('.bubbles-container');

            const color = laneColors[targetConfig.id] || '#ffffff';
            charWrap.style.filter = `drop-shadow(0 0 3vw ${color}) brightness(1.2)`;
            charWrap.classList.add('absorbing');

            gameFrame.classList.add('hyperspace');
            activateSpeedLines(); 

            // 1. Анімуємо існуючі кульки (Всмоктування)
            const existingBubbles = bubbleContainer.querySelectorAll('.bubble');
            const bullRect = charWrap.getBoundingClientRect();
            
            existingBubbles.forEach((b, i) => {
                const rect = b.getBoundingClientRect();
                const bullTargetY = bullRect.top + (bullRect.height * 0.3); 
                const bubbleCenterY = rect.top + (rect.height / 2);
                const deltaY = bullTargetY - bubbleCenterY;

                setTimeout(() => {
                    b.style.transition = 'transform 0.3s cubic-bezier(0.55, 0.085, 0.68, 0.53), opacity 0.2s ease-in, filter 0.2s';
                    b.style.filter = 'brightness(2) contrast(1.5)';
                    b.style.transform = `translateX(-50%) translateY(${deltaY}px) scale(0)`;
                    b.style.opacity = '0'; 
                }, i * 20); 

                setTimeout(() => b.remove(), 400);
            });

            // 2. Стрім нових кульок (з дірками)
            const STREAM_LENGTH = 15;
            const REAL_COUNT = 5;
            const DUMMY_COUNT = STREAM_LENGTH - REAL_COUNT; 
            
            const newBubbles = [];
            
            for(let i=0; i<STREAM_LENGTH; i++) {
                // Вирішуємо, чи буде тут кулька (для реальних і для частини фейкових щоб стрім був цікавішим)
                // Для фейкових (i < DUMMY_COUNT) робимо суцільний потік для ефекту
                // Для реальних (i >= DUMMY_COUNT) робимо дірки
                
                const isReal = i >= DUMMY_COUNT;
                const shouldExist = isReal ? (Math.random() > 0.3) : true;

                if (shouldExist) {
                    const b = document.createElement('div');
                    b.className = `bubble ${targetConfig.cls} blur-move`;
                    b.innerText = targetConfig.val + 'x';
                    
                    const targetBottom = (i - DUMMY_COUNT) * 5.7; 
                    
                    b.style.bottom = `${targetBottom}vw`;
                    b.style.left = '50%';
                    b.style.transform = 'translateX(-50%) translateY(-200vh)'; 
                    b.style.opacity = '1';
                    b.style.top = 'auto'; 
                    
                    bubbleContainer.appendChild(b);
                    newBubbles.push(b);
                }
            }

            requestAnimationFrame(() => {
                bubbleContainer.offsetHeight; 
                newBubbles.forEach(b => {
                    b.style.transition = 'transform 0.35s cubic-bezier(0.25, 1, 0.5, 1)'; 
                    b.style.transform = 'translateX(-50%) translateY(0)'; 
                });
            });

            // Завершення раунду
            setTimeout(() => {
                newBubbles.forEach((b) => {
                    b.classList.remove('blur-move');
                    // Видаляємо ті, що опинилися "нижче" нуля (фейкові з потоку)
                    // Оскільки ми позиціонували їх через bottom, фейкові мають bottom < 0
                    // Але тут ми їх позиціонували математично. Перевіримо стиль.
                    if (parseFloat(b.style.bottom) < 0) {
                        b.remove();
                    }
                });
                
                charWrap.style.filter = 'drop-shadow(0 0.4vw 0.4vw rgba(0,0,0,0.3))';
                charWrap.classList.remove('absorbing');
                gameFrame.classList.remove('hyperspace');
                
                // Повертаємо бичка в центр
                moveBullToCenter();
                isAnimating = false;
            }, 400); 
        }

        function activateSpeedLines() {
            const container = document.getElementById('speed-lines');
            if(!container) return;
            container.innerHTML = ''; 
            container.classList.add('active');
            for(let i=0; i<20; i++) {
                const line = document.createElement('div');
                line.className = 'speed-line';
                line.style.left = Math.random() * 100 + '%';
                line.style.height = (20 + Math.random() * 40) + 'vh';
                line.style.animation = `warpSpeed ${0.2 + Math.random() * 0.2}s linear forwards`;
                container.appendChild(line);
            }
            setTimeout(() => { container.classList.remove('active'); }, 400);
        }

        function handleLaneClick(index, btn, colElement) {
            if (isAnimating) return;
            isAnimating = true;

            index = parseInt(index);
            selectedLaneIndex = index;
            
            // 1. Рухаємо бичка до колонки
            moveBull(index);
            
            // Анімація кнопки
            btn.style.transform = "translateX(-50%) scale(0.9)";
            setTimeout(() => btn.style.transform = "translateX(-50%) scale(1)", 150);

            // Тултіп (якщо треба)
            if (tooltipEl) {
                tooltipEl.classList.remove('active');
                colElement.appendChild(tooltipEl);
                void tooltipEl.offsetWidth; 
                tooltipEl.classList.add('active');
            }

            // 2. Запускаємо екшн через невелику затримку (поки бичок долетить)
            setTimeout(() => {
                playLaneAction(index);
            }, 300);
        }

        function moveBull(index) {
            const targets = document.querySelectorAll('.lane-col');
            let targetEl = null;
            targets.forEach(el => { if(parseInt(el.dataset.index) === index) targetEl = el; });
            if (!targetEl) return;
            const containerRect = document.querySelector('.game-area').getBoundingClientRect();
            const targetRect = targetEl.getBoundingClientRect();
            const relativeX = (targetRect.left + targetRect.width / 2) - containerRect.left;
            charWrap.style.left = `${relativeX}px`;
        }

        function moveBullToCenter() {
            charWrap.style.left = '50%';
        }

        function updateBet(add, mul) {
            if (mul) currentBet *= mul;
            else currentBet += add;
            if (currentBet < 1) currentBet = 1;
            document.getElementById('bet-display').innerText = `$${currentBet.toFixed(2)}`;
        }
        
        // REFRESH BUTTON: Просто оновлює сітку
        document.getElementById('refresh-btn').onclick = () => {
             if (isAnimating) return;
             const btn = document.getElementById('refresh-btn');
             btn.style.transform = "scale(0.95)";
             setTimeout(() => btn.style.transform = "scale(1)", 100);
             if(tooltipEl) tooltipEl.classList.remove('active');
             
             // Просто регенеруємо поле
             regenerateBoard();
        };

        window.onload = init;
        // On resize, if animating, keep at lane, else center
        window.onresize = () => { 
            if(isAnimating) requestAnimationFrame(() => moveBull(selectedLaneIndex));
            else moveBullToCenter();
        };

    </script>
</body>
</html>