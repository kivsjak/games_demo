<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moooon Endless Mode</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Градієнти кульок */
            --grad-1x: linear-gradient(135deg, #aed581 0%, #7cb342 100%);
            --grad-2x: linear-gradient(135deg, #80cbc4 0%, #26a69a 100%);
            --grad-10x: linear-gradient(135deg, #90caf9 0%, #42a5f5 100%);
            --grad-20x: linear-gradient(135deg, #b39ddb 0%, #7e57c2 100%);
            --grad-50x: linear-gradient(135deg, #f48fb1 0%, #ec407a 100%);
            --grad-300x: linear-gradient(135deg, #ffab91 0%, #ff7043 100%);
            
            /* Кольори світіння */
            --glow-1x: #7cb342; --glow-2x: #26a69a; --glow-10x: #42a5f5;
            --glow-20x: #7e57c2; --glow-50x: #ec407a; --glow-300x: #ff7043;
            
            /* Mega Block Colors */
            --mega-glow: #f48fb1;
            --mega-glow-orange: #ffb74d;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            margin: 0; padding: 0; width: 100vw; height: 100vh;
            background: #0d0416; display: flex; justify-content: center; align-items: center;
            font-family: 'Fredoka', sans-serif; overflow: hidden;
        }

        #game-frame {
            position: relative; width: 100%; max-width: 1600px; aspect-ratio: 16/9;
            background: radial-gradient(circle at 50% 30%, #3e2063 0%, #1a0b2e 80%);
            overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; color: white;
            /* CRITICAL FIX: Container Queries support */
            container-type: size;
        }

        @media (min-aspect-ratio: 16/9) { #game-frame { height: 95vh; width: auto; } }
        @media (max-aspect-ratio: 16/9) { #game-frame { width: 95vw; height: auto; } }

        /* --- BACKGROUND --- */
        .stars-container { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .star { position: absolute; background: white; border-radius: 50%; opacity: 0.8; animation: starScroll 10s linear infinite; }
        .bg-cloud { position: absolute; background: radial-gradient(circle, rgba(244, 143, 177, 0.15) 0%, rgba(244, 143, 177, 0) 70%); border-radius: 50%; filter: blur(20px); z-index: 0; animation: floatCloud 20s linear infinite alternate; }
        
        @keyframes starScroll { from { transform: translateY(-10cqh); } to { transform: translateY(110cqh); } }
        @keyframes floatCloud { from { transform: translateX(-5%) translateY(0); } to { transform: translateX(5%) translateY(5%); } }

        /* Speed Lines */
        .speed-lines-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; opacity: 0; transition: opacity 0.2s; }
        .speed-lines-container.active { opacity: 1; }
        .speed-line { position: absolute; width: 2px; background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.9), transparent); top: -50cqh; }
        @keyframes warpSpeed { 0% { transform: translateY(-50cqh); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(150cqh); opacity: 0; } }
        #game-frame.hyperspace .star { animation: warpSpeed 0.3s linear infinite; width: 2px !important; height: 50cqh !important; opacity: 0.5; box-shadow: 0 0 10px white; }
        
        @keyframes flyShake {
            0%, 100% { transform: translateY(0); }
            25% { transform: translateY(-2px); }
            75% { transform: translateY(2px); }
        }
        #game-frame.hyperspace { animation: flyShake 0.1s linear infinite; }
        
        #game-frame.hyperspace #character-wrap svg {
            animation: flyingBull 0.3s ease-in-out infinite !important;
        }
        @keyframes flyingBull {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-0.8cqw) rotate(-8deg); }
        }
        
        #game-frame.hyperspace .bg-cloud {
            animation: cloudFlyDown 0.5s linear infinite !important;
        }
        @keyframes cloudFlyDown {
            from { transform: translateY(-20cqh); opacity: 0.3; }
            to { transform: translateY(120cqh); opacity: 0; }
        }

        /* --- GLOBAL DIM OVERLAY --- */
        #dim-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: black; opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 8; 
        }
        #dim-overlay.active { opacity: 0.4; } 

        /* --- BALANCE WIDGET --- */
        .balance-widget {
            position: absolute; top: 2cqw; left: 2cqw; z-index: 200;
            background: rgba(30, 20, 40, 0.8); border: 0.15cqw solid #7b1fa2;
            padding: 0.5cqw 1.2cqw; border-radius: 2cqw;
            display: flex; gap: 0.8cqw; align-items: center;
            box-shadow: 0 0.5cqw 1cqw rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        .balance-label { font-size: 0.8cqw; color: #e1bee7; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05cqw; }
        .balance-amount { 
            font-size: 1.4cqw; color: #fff; font-weight: 800; font-family: monospace; 
            font-variant-numeric: tabular-nums; 
        }
        
        .balance-change {
            position: absolute; top: 100%; right: 10%; 
            font-size: 1.2cqw; font-weight: 800; 
            opacity: 0; /* Hidden by default */
            pointer-events: none;
            transition: opacity 0.3s, transform 0.1s;
            font-variant-numeric: tabular-nums;
        }
        .balance-change.active { opacity: 1; transform: translateY(0.5cqw); }
        .balance-change.anim-plus { color: #76ff03; }
        .balance-change.anim-minus { color: #ff1744; }


        .cloud-container { 
            position: absolute; top: 15%; right: 5%; width: 22%; z-index: 5; transition: opacity 0.5s; 
            /* Idle animation */
            animation: cloudIdle 4s ease-in-out infinite alternate;
        }
        
        @keyframes cloudIdle {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(-0.5cqw) rotate(1deg); }
        }

        .cloud-svg { width: 100%; filter: drop-shadow(0 0.5cqw 1.5cqw rgba(0,0,0,0.3)); overflow: visible; }
        .sign-group { position: absolute; top: -25%; left: 55%; transform: translateX(-50%) rotate(-6deg); width: 65%; z-index: 10; }
        .sign-board { background: #fbe9e7; border: 0.15cqw solid #d7ccc8; padding: 0.4cqw 0; border-radius: 0.4cqw; color: #3e2723; box-shadow: 0.2cqw 0.4cqw 0 rgba(0,0,0,0.2); text-align: center; position: relative; }
        .sign-board::after { content: ''; position: absolute; bottom: -120%; left: 50%; width: 12%; height: 130%; background: #5d4037; transform: translateX(-50%); z-index: -1; }
        .sign-title { font-size: 1.6cqw; font-weight: 800; line-height: 1; }
        .sign-sub { font-size: 0.9cqw; font-weight: 700; opacity: 0.7; margin-top: 0.1cqw; }

        /* --- GAME AREA (Fixed Layout) --- */
        .game-area {
            flex: 1; position: relative; z-index: 10; display: flex; justify-content: center; align-items: flex-end;
            padding-bottom: 24%; padding-left: 0; transition: opacity 0.5s;
        }
        
        .lanes-grid { display: flex; align-items: flex-end; gap: 1.5cqw; height: 100%; padding-top: 10%; position: relative; }
        .separator { width: 3cqw; }
        
        .lane-col { 
            position: relative; width: 4.5cqw; height: 100%; 
            transition: opacity 0.3s, filter 0.3s;
        }
        
        .lanes-grid.focus-mode .lane-col { opacity: 0.3; filter: grayscale(0.3); }
        .lanes-grid.focus-mode .lane-col.highlighted { opacity: 1; filter: none; z-index: 20; }
        .lanes-grid.focus-mode .lane-col.mega-active { opacity: 0.8; filter: none; z-index: 14; }

        .lane-col::before {
            content: ''; position: absolute; bottom: -5.5cqw; left: 50%; width: 3.5cqw; height: 65cqh;
            background: linear-gradient(to bottom, transparent 0%, rgba(255,255,255,0.05) 100%);
            transform: translateX(-50%); border-radius: 2cqw; z-index: -1;
        }

        /* --- MEGA BLOCK (General) --- */
        .mega-block-item {
            position: absolute;
            bottom: 0; 
            width: 15.5cqw; 
            height: 15.5cqw; 
            background: transparent; 
            z-index: 50;
            display: flex; justify-content: center; align-items: center;
            pointer-events: none; 
        }
        
        /* Background Glow Base */
        .mega-block-item::before {
            content: ''; position: absolute; 
            width: 130%; height: 130%; 
            left: -15%; top: -15%;
            z-index: -1;
            animation: softPulse 3s ease-in-out infinite alternate;
        }

        /* TYPE 1: Pink/Cloudy */
        .mega-block-item.type-1::before {
            background: radial-gradient(circle, 
                rgba(255, 235, 238, 0.7) 0%, 
                rgba(244, 143, 177, 0.4) 40%, 
                rgba(244, 143, 177, 0.1) 60%,
                transparent 70%
            );
        }

        /* TYPE 2: Orange/Sunny */
        .mega-block-item.type-2::before {
            background: radial-gradient(circle, 
                rgba(255, 248, 225, 0.8) 0%, 
                rgba(255, 183, 77, 0.5) 40%, 
                rgba(255, 152, 0, 0.1) 60%,
                transparent 70%
            );
        }

        /* TYPE 3 & 4: Pulsar */
        .mega-block-item.type-3::before,
        .mega-block-item.type-4::before {
            display: none; 
        }
        
        @keyframes softPulse {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.05); opacity: 1; }
        }

        /* Container for rotating outer bubbles */
        .mega-ring {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0;
            animation: galaxySpin 20s linear infinite;
            z-index: 5;
        }
        @keyframes galaxySpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Базові стилі для кульок мєгаблоку */
        .mega-bubble {
            position: absolute;
            width: 3.5cqw; height: 3.5cqw;
            animation: counterSpin 20s linear infinite; 
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-weight: 800; font-size: 0.9cqw; color: white;
            transition: transform 0.2s, background 0.3s, box-shadow 0.3s, filter 0.3s;
        }
        @keyframes counterSpin { from { transform: rotate(0deg); } to { transform: rotate(-360deg); } }

        /* Мєгаблок 1 - Голубі кульки */
        .mega-block-item.type-1 .mega-bubble {
            background: radial-gradient(circle at 30% 30%, #e1f5fe, #03a9f4);
            box-shadow: 0 0 0.5cqw #81d4fa;
        }
        .mega-block-item.type-1 .mega-bubble.center-bubble {
            position: absolute; z-index: 10;
            width: 5cqw; height: 5cqw;
            background: radial-gradient(circle at 30% 30%, #fff, #0288d1);
            box-shadow: 0 0 2cqw #0288d1; font-size: 1.4cqw;
            animation: none; 
        }

        /* Мєгаблок 2 - Темно фіолетові кульки */
        .mega-block-item.type-2 .mega-bubble {
            background: radial-gradient(circle at 30% 30%, #9575cd, #311b92);
            box-shadow: 0 0 0.5cqw #7e57c2;
        }
        .mega-block-item.type-2 .mega-bubble.center-bubble {
            position: absolute; z-index: 10;
            width: 5cqw; height: 5cqw;
            background: radial-gradient(circle at 30% 30%, #fff, #1a237e);
            box-shadow: 0 0 2cqw #1a237e; font-size: 1.4cqw;
            animation: none; 
        }

        /* --- PULSAR (Type 3) STYLES --- */
        .pulsar-core {
            position: absolute;
            width: 10cqw; height: 10cqw;
            background: radial-gradient(circle, #e0f7fa 0%, #4fc3f7 40%, #0288d1 80%, #01579b 100%);
            border-radius: 50%;
            box-shadow: 0 0 3cqw #03a9f4, 0 0 6cqw #0277bd;
            animation: pulsarDeepBreath 5s ease-in-out infinite;
            z-index: 15;
            display: flex; justify-content: center; align-items: center;
        }
        .pulsar-core::after {
            content: ''; position: absolute; width: 120%; height: 120%;
            border-radius: 50%;
            border: 2px solid rgba(79, 195, 247, 0.3);
            animation: pulsarRings 3s linear infinite;
        }
        
        /* --- ORANGE PULSAR x2 (Type 4) STYLES --- */
        .mega-block-item.type-4 .pulsar-core {
            background: radial-gradient(circle, #fff3e0 0%, #ffb74d 40%, #ef6c00 80%, #e65100 100%);
            box-shadow: 0 0 3cqw #ff9800, 0 0 6cqw #ef6c00;
        }
        .mega-block-item.type-4 .pulsar-core::after {
             border: 2px solid rgba(255, 152, 0, 0.3);
        }
        .pulsar-text {
            font-size: 3cqw; font-weight: 900; color: white;
            text-shadow: 0 0 1cqw #e65100; z-index: 20;
        }

        @keyframes pulsarDeepBreath {
            0%, 100% { transform: scale(1); box-shadow: 0 0 3cqw #03a9f4, 0 0 6cqw #0277bd; }
            50% { transform: scale(1.1); box-shadow: 0 0 5cqw #29b6f6, 0 0 10cqw #0288d1; filter: brightness(1.2); }
        }
        /* Override animation for Orange */
        .mega-block-item.type-4 .pulsar-core {
             animation: pulsarDeepBreathOrange 5s ease-in-out infinite;
        }
        @keyframes pulsarDeepBreathOrange {
            0%, 100% { transform: scale(1); box-shadow: 0 0 3cqw #ff9800, 0 0 6cqw #ef6c00; }
            50% { transform: scale(1.1); box-shadow: 0 0 5cqw #ffa726, 0 0 10cqw #e65100; filter: brightness(1.2); }
        }

        @keyframes pulsarRings {
            0% { transform: scale(0.8); opacity: 0; }
            50% { opacity: 0.5; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        /* Shockwave for Pulsar */
        #shockwave-overlay {
            position: absolute; top: 50%; left: 50%;
            width: 0; height: 0; border-radius: 50%;
            background: radial-gradient(circle, rgba(225,245,254,1) 0%, rgba(3,169,244,0.8) 40%, rgba(1,87,155,0) 70%);
            transform: translate(-50%, -50%);
            pointer-events: none; z-index: 1000;
            opacity: 0;
        }
        #shockwave-overlay.active {
            animation: shockwaveExpand 0.8s ease-out forwards;
        }
        @keyframes shockwaveExpand {
            0% { width: 0; height: 0; opacity: 1; }
            100% { width: 300cqw; height: 300cqw; opacity: 0; }
        }
        /* Orange shockwave modification applied via JS or strict class */

        .mega-bubble.win-state {
            background: radial-gradient(circle at 30% 30%, #ccff90, #64dd17) !important;
            box-shadow: 0 0 2cqw #64dd17 !important; color: #1b5e20;
            transform: scale(1.1); 
            animation: none !important; 
        }
        .mega-bubble.lose-state {
            /* Just darken, don't replace background */
            box-shadow: none !important;
            filter: grayscale(1) brightness(0.3);
            opacity: 0.7;
            transform: scale(0.9);
            animation: none !important;
        }
        
        /* Bubble Explosion Style */
        .bubble.exploded-win {
            background: #76ff03 !important;
            box-shadow: 0 0 4cqw #76ff03;
            transform: translateX(-50%) scale(1.3) !important;
            color: #1b5e20 !important;
            border: 2px solid #fff;
            transition: transform 0.1s, opacity 0.3s;
            z-index: 100;
        }
        .bubble.exploded-loss {
            /* Just darken, don't replace */
            transform: translateX(-50%) scale(0.8) !important;
            box-shadow: none !important;
            filter: grayscale(1) brightness(0.3);
            opacity: 0.5;
            transition: transform 0.1s, opacity 0.3s;
        }
        
        /* Regular Lane Win Flash */
        .bubble.bubble-hit-win {
            background: #76ff03 !important;
            box-shadow: 0 0 3cqw #76ff03 !important;
            color: #1b5e20 !important;
            transform: translateX(-50%) scale(1.2);
            transition: all 0.1s ease;
        }
        
        /* Bubble Doubled Animation */
        .bubble.doubled {
            animation: doublePop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .bubble.type-x2-converted {
            background: radial-gradient(circle at 30% 30%, #fff3e0, #ffb74d) !important;
            box-shadow: 0 0 1.5cqw #ff9800, inset 0 0 1cqw rgba(255,255,255,0.5) !important;
            color: #e65100 !important;
            font-weight: 800 !important;
        }
        
        @keyframes doublePop {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.4); }
            100% { transform: translateX(-50%) scale(1); }
        }

        /* Bubbles */
        .bubbles-container { 
            position: absolute; width: 100%; bottom: 0; height: 150cqh; left: 0; pointer-events: none;
        }
        
        .lane-col.highlighted .bubbles-container {
            clip-path: inset(0 0 var(--clip-bottom, 0px) 0);
        }
        
        .bubble {
            position: absolute; left: 50%; transform: translateX(-50%); width: 4.5cqw; height: 4.5cqw;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-weight: 700; font-size: 1.3cqw; color: white; text-shadow: 0 0 5px rgba(0,0,0,0.5);
            z-index: 2; transition: transform 0.2s, box-shadow 0.15s; transform-origin: center center; 
        }
        
        .bubble.pop-in { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: translateX(-50%) scale(0); } to { transform: translateX(-50%) scale(1); } }
        
        .bubble::after { content: ''; position: absolute; top: 10%; left: 15%; width: 30%; height: 20%; border-radius: 50%; background: rgba(255,255,255,0.7); filter: blur(2px); transform: rotate(-45deg); }
        
        /* CENTER WIN TEXT */
        .center-win-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-family: 'Fredoka', sans-serif;
            font-weight: 900; font-size: 8cqw;
            color: #76ff03; 
            text-shadow: 0 0 2cqw rgba(118, 255, 3, 0.6), 0 0.5cqw 0 #33691e;
            pointer-events: none; z-index: 1000;
            white-space: nowrap;
            /* Default quick pop animation */
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-variant-numeric: tabular-nums;
            opacity: 1;
        }
        .center-win-text.pop {
            transform: translate(-50%, -50%) scale(1.2);
        }
        /* New Fading Out State */
        .center-win-text.fading-out {
            opacity: 0;
            transform: translate(-50%, -150%) scale(1.1); /* Fly up */
            transition: opacity 0.4s ease-in, transform 0.4s ease-in; /* Override for smooth exit */
        }
        
        @keyframes bigWinPop { 
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.1); } 
            15% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            30% { transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }

        .b-1x { background: radial-gradient(circle at 30% 30%, #dcedc8, var(--glow-1x)); box-shadow: 0 0 1.5cqw var(--glow-1x), inset 0 0 1cqw rgba(255,255,255,0.5); }
        .b-2x { background: radial-gradient(circle at 30% 30%, #b2dfdb, var(--glow-2x)); box-shadow: 0 0 1.5cqw var(--glow-2x), inset 0 0 1cqw rgba(255,255,255,0.5); }
        .b-10x { background: radial-gradient(circle at 30% 30%, #bbdefb, var(--glow-10x)); box-shadow: 0 0 1.5cqw var(--glow-10x), inset 0 0 1cqw rgba(255,255,255,0.5); }
        .b-20x { background: radial-gradient(circle at 30% 30%, #d1c4e9, var(--glow-20x)); box-shadow: 0 0 1.5cqw var(--glow-20x), inset 0 0 1cqw rgba(255,255,255,0.5); }
        .b-50x { background: radial-gradient(circle at 30% 30%, #f8bbd0, var(--glow-50x)); box-shadow: 0 0 1.5cqw var(--glow-50x), inset 0 0 1cqw rgba(255,255,255,0.5); }
        .b-300x { background: radial-gradient(circle at 30% 30%, #ffccbc, var(--glow-300x)); box-shadow: 0 0 1.5cqw var(--glow-300x), inset 0 0 1cqw rgba(255,255,255,0.5); }
        
        .b-1x.glowing { box-shadow: 0 0 3cqw 1cqw var(--glow-1x), inset 0 0 1cqw rgba(255,255,255,0.5); }

        .lane-arrow {
            position: absolute; bottom: -5.5cqw; left: 50%; transform: translateX(-50%); width: 4.5cqw; height: 4.5cqw;
            border-radius: 50%; background: rgba(255,255,255,0.1); border: 0.15cqw solid rgba(255,255,255,0.2);
            display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 100; transition: transform 0.1s;
        }
        .lane-arrow:hover { background: rgba(255,255,255,0.25); transform: translateX(-50%) scale(1.05); }
        .lane-arrow svg { width: 50%; fill: rgba(255,255,255,0.7); }

        #character-wrap {
            position: absolute;
            bottom: calc(14% + 25px);
            left: 50%; 
            transform: translateX(-50%) scale(var(--bull-scale, 1)); 
            width: 8cqw; height: 8cqw; z-index: 20;
            transition: left 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94), filter 0.1s ease, transform 0.15s ease;
            --bull-scale: 1;
        }
        
        #character-wrap svg { animation: hovering 2s ease-in-out infinite; transition: transform 0.1s; }
        #character-wrap.absorbing svg { transform: scale(1.3); }
        
        /* BULL SUPER GREEN FLASH STATE - GLOW ONLY, NO COLOR CHANGE */
        #character-wrap.bull-hit-active svg {
            /* Strong green drop-shadow to create "aura", slight brightness boost */
            filter: drop-shadow(0 0 2cqw #76ff03) drop-shadow(0 0 4cqw #76ff03) brightness(1.2) !important;
            transform: scale(1.15);
            transition: filter 0.1s, transform 0.1s;
        }
        
        @keyframes hovering { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-0.6cqw); } }

        #target-point { position: absolute; top: 15%; left: 50%; width: 1px; height: 1px; background: transparent; }

        .controls-wrapper { position: absolute; bottom: 2%; left: 50%; transform: translateX(-50%); z-index: 100; width: 28%; transition: opacity 0.5s; }
        .controls-wrapper.hidden { opacity: 0; pointer-events: none; }
        .panel-bg { background: #332219; border-radius: 1.5cqw; padding: 1cqw 1.2cqw; display: flex; flex-direction: column; gap: 0.8cqw; box-shadow: 0 1cqw 2cqw rgba(0,0,0,0.6); border: 0.15cqw solid #523c2e; height: auto; }
        .bet-row { display: flex; justify-content: space-between; align-items: flex-end; width: 100%; padding: 0 0.5cqw; }
        .bet-group { display: flex; flex-direction: column; align-items: center; }
        .bet-label { font-size: 0.7cqw; color: #bebdb8; font-weight: 800; margin-bottom: 0.3cqw; text-transform: uppercase; letter-spacing: 0.05cqw; }
        .symbol-btn { background: none; border: none; color: #bebdb8; font-size: 2cqw; font-weight: 900; cursor: pointer; padding: 0; line-height: 1; height: 2cqw; display: flex; align-items: center; transition: transform 0.1s; }
        .symbol-btn:active { transform: scale(0.9); color: white; }
        .input-pill { background: #e6dac7; border-radius: 0.8cqw; height: 2.8cqw; width: 12cqw; display: flex; justify-content: space-between; align-items: center; padding: 0 0.5cqw; box-shadow: inset 0 0.2cqw 0.4cqw rgba(0,0,0,0.1); }
        .pill-btn { background: none; border: none; font-size: 0.9cqw; font-weight: 700; color: #594d42; cursor: pointer; padding: 0 0.4cqw; }
        .pill-btn:hover { color: #2b1808; }
        .bet-value { font-size: 1.2cqw; font-weight: 800; color: #382e25; }
        .actions-row { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-top: 0.2cqw; }
        .btn-3d { border: none; border-radius: 50%; color: white; font-weight: 700; cursor: pointer; position: relative; display: flex; justify-content: center; align-items: center; transition: top 0.1s, box-shadow 0.1s; }
        .btn-3d:active { top: 0.3cqw; box-shadow: none !important; }
        .btn-purple { width: 3.2cqw; height: 3.2cqw; font-size: 1.6cqw; background: linear-gradient(to bottom, #9c6ade, #7a46b5); box-shadow: 0 0.3cqw 0 #4a2c66; border: 0.15cqw solid #6e4494; }
        .btn-orange { width: 3.2cqw; height: 3.2cqw; font-size: 1.4cqw; background: linear-gradient(to bottom, #ea7d27, #c45d0f); box-shadow: 0 0.3cqw 0 #8f4209; border: 0.15cqw solid #b05713; }
        .btn-blue { border-radius: 0.8cqw; height: 3.2cqw; width: 10cqw; font-size: 1.4cqw; font-family: 'Fredoka', sans-serif; font-weight: 800; text-transform: uppercase; background: linear-gradient(to bottom, #29aae1, #1c85b5); box-shadow: 0 0.3cqw 0 #105a7d; border: 0.15cqw solid #1e7ba3; text-shadow: 0 0.1cqw 0.1cqw rgba(0,0,0,0.2); }

        .tooltip-box {
            position: absolute; bottom: 0.5cqw; left: 50%; transform: translateX(-50%) translateY(0);
            background: #221606; padding: 0.8cqw 1.2cqw; border-radius: 0.6cqw; border-left: 0.3cqw solid #a1887f; width: 12cqw;
            box-shadow: 0 1cqw 2cqw rgba(0,0,0,0.5); z-index: 200; pointer-events: none; opacity: 0; transition: opacity 0.3s, transform 0.3s;
        }
        .tooltip-box.active { opacity: 1; transform: translateX(-50%) translateY(0); }
        .tooltip-box::after { content: ''; position: absolute; left: 50%; bottom: -0.5cqw; transform: translateX(-50%); border-width: 0.5cqw 0.5cqw 0 0.5cqw; border-style: solid; border-color: #221606 transparent transparent transparent; }
        .tt-row { display: flex; justify-content: space-between; font-size: 0.9cqw; margin-bottom: 0.3cqw; }
        .tt-label { color: #bdbdbd; font-weight: 600; }
        .tt-val { color: #fff; font-weight: 700; }

    </style>
</head>
<body>

    <div id="dim-overlay"></div>
    <div id="shockwave-overlay"></div>
    
    <div id="game-frame">
        <!-- Balance Widget inside Frame -->
        <div class="balance-widget">
            <div class="balance-label">Balance</div>
            <div class="balance-amount" id="balance-el">$10,000.00</div>
            <div class="balance-change" id="balance-change"></div>
        </div>

        <div class="stars-container" id="star-container"></div>
        <div class="speed-lines-container" id="speed-lines"></div>
        <div class="bg-cloud" style="width: 30cqw; height: 30cqw; top: 10%; left: 10%;"></div>
        <div class="bg-cloud" style="width: 40cqw; height: 40cqw; top: 40%; right: -10%; animation-delay: -5s;"></div>
        
        <div class="cloud-container">
            <svg class="cloud-svg" viewBox="0 0 220 140">
                <defs>
                    <linearGradient id="cloudGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#f8bbd0;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#f48fb1;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <g fill="url(#cloudGrad)">
                    <circle cx="50" cy="80" r="40" />
                    <circle cx="90" cy="60" r="50" />
                    <circle cx="140" cy="70" r="45" />
                    <circle cx="180" cy="90" r="35" />
                    <circle cx="110" cy="100" r="40" />
                    <circle cx="60" cy="110" r="30" />
                </g>
                <circle cx="70" cy="50" r="10" fill="white" opacity="0.2"/>
                <circle cx="120" cy="40" r="15" fill="white" opacity="0.2"/>
                <circle cx="160" cy="60" r="8" fill="white" opacity="0.2"/>
            </svg>
            <div class="sign-group">
                <div class="sign-board">
                    <div class="sign-title">Moooon</div>
                    <div class="sign-sub" id="km-counter">0 km</div>
                </div>
            </div>
        </div>

        <div class="game-area">
            <div class="lanes-grid" id="lanes"></div>
        </div>

        <div id="character-wrap">
            <div id="target-point"></div> 
            <svg viewBox="0 0 100 100" style="width: 100%; height: 100%; filter: drop-shadow(0 0.4cqw 0.4cqw rgba(0,0,0,0.3));">
                <g transform="translate(15, 20)">
                    <rect x="15" y="25" width="40" height="35" rx="10" fill="#c62828" />
                    <path d="M20,55 L20,70 L25,70 L25,55" fill="#3e2723"/>
                    <path d="M45,55 L45,70 L50,70 L50,55" fill="#3e2723"/>
                    <path d="M10,15 H60 V50 H10 Z" fill="#e57373" rx="8" style="fill:#ef5350; stroke:#b71c1c; stroke-width:2; stroke-linejoin:round;"/>
                    <rect x="10" y="15" width="50" height="35" rx="8" fill="#ef5350" />
                    <path d="M10,20 Q-5,10 5,-5 L12,15" fill="white" stroke="#cfd8dc" stroke-width="1"/>
                    <path d="M60,20 Q75,10 65,-5 L58,15" fill="white" stroke="#cfd8dc" stroke-width="1"/>
                    <circle cx="25" cy="30" r="6" fill="white"/>
                    <circle cx="25" cy="30" r="2" fill="black"/>
                    <circle cx="45" cy="30" r="6" fill="white"/>
                    <circle cx="45" cy="30" r="2" fill="black"/>
                    <path d="M18,25 L32,25" stroke="#3e2723" stroke-width="2"/>
                    <path d="M38,25 L52,25" stroke="#3e2723" stroke-width="2"/>
                    <rect x="25" y="40" width="20" height="8" rx="4" fill="#3e2723"/>
                    <circle cx="29" cy="44" r="1.5" fill="#a1887f"/>
                    <circle cx="41" cy="44" r="1.5" fill="#a1887f"/>
                </g>
            </svg>
        </div>

        <div class="controls-wrapper">
            <div class="panel-bg">
                <div class="bet-row">
                    <div class="bet-group">
                        <div class="bet-label">MIN</div>
                        <button class="symbol-btn" onclick="updateBet(-1)">−</button>
                    </div>
                    <div class="bet-group">
                        <div class="bet-label">BET AMOUNT</div>
                        <div class="input-pill">
                            <button class="pill-btn" onclick="updateBet(0, 0.5)">½</button>
                            <div class="bet-value" id="bet-display">$10.00</div>
                            <button class="pill-btn" onclick="updateBet(0, 2)">2x</button>
                        </div>
                    </div>
                    <div class="bet-group">
                        <div class="bet-label">MAX</div>
                        <button class="symbol-btn" onclick="updateBet(1)">+</button>
                    </div>
                </div>
                <div class="actions-row">
                    <button class="btn-3d btn-purple">?</button>
                    <button class="btn-3d btn-blue" id="refresh-btn">REFRESH</button>
                    <button class="btn-3d btn-orange">»</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const laneColors = { 1: '#7cb342', 2: '#26a69a', 3: '#42a5f5', 4: '#7e57c2', 5: '#ec407a', 6: '#ff7043' };
        
        const lanesStructure = [
            { id: 1, base: 1.1, cls: 'b-1x' }, 
            { id: 2, base: 2, cls: 'b-2x' }, 
            { id: 3, base: 10, cls: 'b-10x' },
            { id: 'sep' }, 
            { id: 4, base: 20, cls: 'b-20x' }, 
            { id: 5, base: 50, cls: 'b-50x' }, 
            { id: 6, base: 300, cls: 'b-300x' } 
        ];

        const lanesContainer = document.getElementById('lanes');
        const charWrap = document.getElementById('character-wrap');
        const gameFrame = document.getElementById('game-frame');
        const kmCounter = document.getElementById('km-counter');
        const dimOverlay = document.getElementById('dim-overlay');
        const balanceEl = document.getElementById('balance-el');
        const shockwaveEl = document.getElementById('shockwave-overlay');
        
        let currentBet = 10.00;
        let currentBalance = 10000.00; 
        let displayBalance = 10000.00; 
        let currentRoundWin = 0; 
        let selectedLaneIndex = 0; 
        let tooltipEl = null;
        let isAnimating = false; 
        let currentKm = 0;
        let laneMultipliers = {};
        let arrowClickCount = 0; 
        let currentMegaBlock = null; 
        let bullFlashTimer = null;
        let hideBalanceTimer = null;
        
        // Accumulator vars for center text
        let activeWinTextEl = null;
        let activeWinAmount = 0;
        let activeWinDisplay = 0;
        let activeWinTimer = null;

        function generateLaneMultiplier(laneId) {
            const lane = lanesStructure.find(l => l.id === laneId);
            if (!lane) return 1;
            let variance = 0;
            if (lane.base < 2) variance = 0.4;
            else if (lane.base < 10) variance = 1.5;
            else if (lane.base < 50) variance = 10;
            else variance = 50;
            let val = lane.base + (Math.random() * variance * 2 - variance);
            if (val < 10) return val.toFixed(1);
            return Math.round(val);
        }
        
        function getRandomVal(laneId) {
            if (laneMultipliers[laneId] === undefined) {
                laneMultipliers[laneId] = generateLaneMultiplier(laneId);
            }
            return laneMultipliers[laneId];
        }
        
        function refreshAllMultipliers() {
            laneMultipliers = {};
            lanesStructure.forEach(lane => {
                if (lane.id !== 'sep') {
                    laneMultipliers[lane.id] = generateLaneMultiplier(lane.id);
                }
            });
        }

        const starContainer = document.getElementById('star-container');
        for(let i=0; i<50; i++) {
            const s = document.createElement('div');
            s.className = 'star';
            s.style.top = Math.random()*100 + '%';
            s.style.left = Math.random()*100 + '%';
            const size = Math.random()*0.3 + 0.1;
            s.style.width = size + 'vw'; // Still using vw for stars as they are purely bg
            s.style.height = size + 'vw';
            s.style.animationDuration = (8 + Math.random()*10) + 's';
            s.style.animationDelay = (Math.random()*-20) + 's';
            starContainer.appendChild(s);
        }

        function init() {
            createTooltip();
            moveBullToCenter();
            updateKmDisplay();
            updateBalanceDisplay(0, true); 
            spawnGrid(false, false); 
            requestAnimationFrame(animateBalanceLoop); 
        }

        function createTooltip() {
            tooltipEl = document.createElement('div');
            tooltipEl.className = 'tooltip-box';
        }

        function updateKmDisplay() {
            kmCounter.innerText = `${currentKm} km`;
        }

        function animateBalanceLoop() {
            // Main Balance
            if (Math.abs(displayBalance - currentBalance) > 0.01) {
                const diff = currentBalance - displayBalance;
                let step = diff * 0.15; 
                if (Math.abs(step) < 0.01) {
                    displayBalance = currentBalance;
                } else {
                    displayBalance += step;
                }
                balanceEl.innerText = '$' + displayBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            } else if (displayBalance !== currentBalance) {
                displayBalance = currentBalance;
                balanceEl.innerText = '$' + displayBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }

            // Center Win Text Rolling
            if (activeWinTextEl) {
                if (Math.abs(activeWinDisplay - activeWinAmount) > 0.1) {
                    const winDiff = activeWinAmount - activeWinDisplay;
                    // Fast lerp
                    activeWinDisplay += winDiff * 0.2; 
                    activeWinTextEl.innerText = `WIN +$${activeWinDisplay.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                } else if (activeWinDisplay !== activeWinAmount) {
                    activeWinDisplay = activeWinAmount;
                    activeWinTextEl.innerText = `WIN +$${activeWinDisplay.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                }
            }

            requestAnimationFrame(animateBalanceLoop);
        }

        function updateBalanceDisplay(amountToAdd = 0, reset = false) {
            const changeEl = document.getElementById('balance-change');
            
            if (reset) {
                currentRoundWin = 0;
                return;
            }

            if (amountToAdd < 0) {
                return; 
            }

            if (amountToAdd > 0) {
                // If the element is currently hiding (fading out), remove that class first
                // to bring it back to full opacity immediately.
                if (changeEl.classList.contains('hiding')) {
                    changeEl.classList.remove('hiding');
                }

                currentRoundWin += amountToAdd;
                
                changeEl.innerText = '+$' + currentRoundWin.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                changeEl.className = 'balance-change active anim-plus';
                
                // Reset Hide Timer
                if (hideBalanceTimer) clearTimeout(hideBalanceTimer);
                
                // Set new timer to trigger fade out
                hideBalanceTimer = setTimeout(() => {
                    // Instead of removing active (which stops float), add hiding (opacity 0)
                    changeEl.classList.add('hiding');
                    
                    // After fade out completes (300ms transition), reset everything
                    setTimeout(() => {
                        changeEl.className = 'balance-change'; // Reset classes
                        currentRoundWin = 0; 
                    }, 300);
                }, 600); // Wait 600ms after last win
            }
        }

        function regenerateBoard() {
            arrowClickCount = 0; 
            currentMegaBlock = null;
            refreshAllMultipliers();
            lanesContainer.innerHTML = '';
            spawnGrid(false, false);
        }

        function spawnGrid(animateIn = true, useMegaLogic = true) {
            if (useMegaLogic) {
                if (arrowClickCount > 0 && arrowClickCount % 3 === 0) {
                    const side = Math.random() < 0.5 ? 'left' : 'right';
                    const laneIndices = side === 'left' ? [0, 1, 2] : [3, 4, 5];
                    const type = Math.floor(Math.random() * 4) + 1;
                    currentMegaBlock = { side, laneIndices, type };
                } else {
                    currentMegaBlock = null;
                }
            } else {
                currentMegaBlock = null;
            }

            let colsExist = document.querySelectorAll('.lane-col').length > 0;
            if (!colsExist) {
                let logicalIndex = 0;
                lanesStructure.forEach((lane) => {
                    if (lane.id === 'sep') {
                        const sep = document.createElement('div');
                        sep.className = 'separator';
                        lanesContainer.appendChild(sep);
                        return;
                    }
                    const col = document.createElement('div');
                    col.className = 'lane-col';
                    col.id = `lane-${lane.id}`;
                    col.dataset.index = logicalIndex;
                    
                    const bubbleContainer = document.createElement('div');
                    bubbleContainer.className = 'bubbles-container';
                    col.appendChild(bubbleContainer);

                    const arrow = document.createElement('div');
                    arrow.className = 'lane-arrow';
                    arrow.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 4l-8 8h6v8h4v-8h6z" /></svg>`;
                    arrow.onclick = () => handleLaneClick(col.dataset.index, arrow, col);
                    arrow.onmouseenter = () => showTooltip(col);
                    arrow.onmouseleave = () => hideTooltip();
                    col.appendChild(arrow);
                    
                    lanesContainer.appendChild(col);
                    logicalIndex++;
                });
            }

            refreshAllMultipliers();
            fillRibbon(animateIn);
        }

        function fillRibbon(animateIn) {
            let logicalIndex = 0;
            const elementsToAnimate = [];

            lanesStructure.forEach((lane) => {
                if (lane.id === 'sep') return;

                const col = document.getElementById(`lane-${lane.id}`);
                const bubbleContainer = col.querySelector('.bubbles-container');
                
                let isMegaLane = currentMegaBlock && currentMegaBlock.laneIndices.includes(logicalIndex);
                if (isMegaLane) col.classList.add('mega-active');
                else col.classList.remove('mega-active');

                for(let i=0; i<5; i++) {
                    if (isMegaLane && i < 3) continue; 
                    if (Math.random() > 0.3) {
                         const b = document.createElement('div');
                         b.className = `bubble ${lane.cls}`;
                         b.innerText = getRandomVal(lane.id) + 'x';
                         
                         const targetBottom = i * 5.7;
                         b.style.bottom = `${targetBottom}cqw`;
                         b.style.left = '50%';
                         
                         if (animateIn) {
                             b.style.transform = 'translateX(-50%) translateY(-200vh)';
                             b.style.transition = 'none'; 
                         } else {
                             b.classList.add('pop-in');
                             b.style.transform = 'translateX(-50%)';
                         }
                         
                         bubbleContainer.appendChild(b);
                         if (animateIn) elementsToAnimate.push(b);
                    }
                }
                logicalIndex++;
            });

            if (currentMegaBlock) {
                const megaItem = document.createElement('div');
                megaItem.className = `mega-block-item type-${currentMegaBlock.type}`; 
                
                if (currentMegaBlock.side === 'left') {
                    megaItem.style.left = '0'; 
                } else {
                    megaItem.style.right = '0'; 
                }
                
                if (currentMegaBlock.type === 3 || currentMegaBlock.type === 4) {
                    const core = document.createElement('div');
                    core.className = 'pulsar-core';
                    if(currentMegaBlock.type === 4) {
                        core.innerHTML = '<span class="pulsar-text">x2</span>';
                    }
                    megaItem.appendChild(core);
                } else {
                    const centerB = document.createElement('div');
                    centerB.className = 'mega-bubble center-bubble';
                    if (currentMegaBlock.type === 1) {
                        centerB.innerText = '25x';
                    } else {
                        centerB.innerText = [50, 75, 100, 200][Math.floor(Math.random()*4)] + 'x';
                    }
                    megaItem.appendChild(centerB);

                    const ring = document.createElement('div');
                    ring.className = 'mega-ring';
                    megaItem.appendChild(ring);

                    const radius = 5.5; 
                    for(let k=0; k<8; k++) {
                        const mb = document.createElement('div');
                        mb.className = 'mega-bubble';
                        
                        if (currentMegaBlock.type === 1) {
                            mb.innerText = '25x';
                        } else {
                            const possibleVals = [5, 10, 15, 20, 25, 30, 50, 100];
                            mb.innerText = possibleVals[Math.floor(Math.random()*possibleVals.length)] + 'x';
                        }

                        const angle = k * (360 / 8);
                        
                        const rad = radius; 
                        const angRad = angle * (Math.PI/180);
                        mb.style.top = `calc(50% + ${Math.sin(angRad) * radius}cqw - 1.75cqw)`;
                        mb.style.left = `calc(50% + ${Math.cos(angRad) * radius}cqw - 1.75cqw)`;
                        mb.style.transform = 'none'; 
                        
                        ring.appendChild(mb);
                    }
                }

                lanesContainer.appendChild(megaItem);

                if (animateIn) {
                    megaItem.style.transition = 'none';
                    megaItem.style.transform = 'translateY(-200vh)';
                    elementsToAnimate.push(megaItem);
                }
            }

            if (animateIn && elementsToAnimate.length > 0) {
                document.body.offsetHeight; 
                elementsToAnimate.forEach(el => {
                    el.style.transition = 'transform 0.5s cubic-bezier(0.25, 1, 0.5, 1)';
                    if(el.classList.contains('mega-block-item')) {
                        el.style.transform = 'translateY(0)';
                    } else {
                        el.style.transform = 'translateX(-50%) translateY(0)';
                    }
                });
            }
        }

        function showTooltip(colElement) {
            if (isAnimating || !tooltipEl) return;
            
            const logicalIndex = parseInt(colElement.dataset.index);
            let isMega = false;
            if (currentMegaBlock && currentMegaBlock.laneIndices.includes(logicalIndex)) {
                isMega = true;
            }

            let count = 0;

            if (isMega) {
                if (currentMegaBlock.type === 1 || currentMegaBlock.type === 2) {
                    // Types 1 and 2 always have 9 balls (1 center + 8 ring)
                    count = 9;
                } else {
                    // Types 3 and 4 (Pulsar) play ALL bubbles on the screen
                    const allBubbles = document.querySelectorAll('.bubble:not(.mega-bubble)');
                    count = allBubbles.length;
                }
            } else {
                // Normal lane: count bubbles in this column
                const bubbles = colElement.querySelectorAll('.bubble:not(.mega-bubble)');
                count = bubbles.length;
            }

            // Updated Label and Value
            tooltipEl.innerHTML = `<div class="tt-row"><span class="tt-label">Total Bet</span><span class="tt-val">${count}</span></div>`;
            colElement.appendChild(tooltipEl);
            void tooltipEl.offsetWidth; 
            tooltipEl.classList.add('active');
        }

        function hideTooltip() {
            if (tooltipEl) {
                tooltipEl.classList.remove('active');
            }
        }

        function handleLaneClick(index, btn, colElement) {
            if (isAnimating) return;
            isAnimating = true;

            index = parseInt(index);
            selectedLaneIndex = index;
            
            btn.style.transform = "translateX(-50%) scale(0.9)";
            setTimeout(() => btn.style.transform = "translateX(-50%) scale(1)", 150);
            if(tooltipEl) tooltipEl.classList.remove('active');

            const changeEl = document.getElementById('balance-change');
            changeEl.className = 'balance-change'; 
            currentRoundWin = 0; 
            
            // RESET SINGLETON CENTER TEXT ON NEW ROUND
            if(activeWinTextEl) {
                activeWinTextEl.remove();
                activeWinTextEl = null;
                activeWinAmount = 0;
                activeWinDisplay = 0;
                if(activeWinTimer) clearTimeout(activeWinTimer);
            }

            arrowClickCount++; 

            if (currentMegaBlock && currentMegaBlock.laneIndices.includes(index)) {
                playMegaBlockSequence(index);
            } else {
                currentBalance -= currentBet;
                
                moveBull(index);
                setTimeout(() => {
                    playLaneAction(index);
                }, 300);
            }
        }

        function triggerBullWinFlash() {
            charWrap.classList.add('bull-hit-active');
            
            if(bullFlashTimer) clearTimeout(bullFlashTimer);
            
            bullFlashTimer = setTimeout(() => {
                charWrap.classList.remove('bull-hit-active');
            }, 300);
        }

        function playLaneAction(targetLaneIndex, skipMoveBull = false) {
            charWrap.classList.add('absorbing');
            gameFrame.classList.add('hyperspace');
            activateSpeedLines();
            
            document.querySelector('.lanes-grid').classList.add('focus-mode');
            dimOverlay.classList.add('active');

            let targetLaneConfig = null;
            let idx = 0;
            for(let l of lanesStructure) {
                if(l.id === 'sep') continue;
                if(idx === targetLaneIndex) {
                    targetLaneConfig = l;
                    break;
                }
                idx++;
            }
            
            if(targetLaneConfig) {
                const color = laneColors[targetLaneConfig.id] || '#ffffff';
                charWrap.style.filter = `drop-shadow(0 0 3cqw ${color}) brightness(1.2)`;
            }

            const oldMega = document.querySelector('.mega-block-item');
            if (oldMega) {
                oldMega.style.transition = 'transform 0.4s ease-in';
                oldMega.style.transform = 'translateY(100vh)'; 
            }

            let logicalIndex = 0;
            let totalRoundWin = 0;

            lanesStructure.forEach((lane) => {
                if (lane.id === 'sep') return;

                const col = document.getElementById(`lane-${lane.id}`);
                const bubbleContainer = col.querySelector('.bubbles-container');
                const isSelected = (logicalIndex === targetLaneIndex);
                
                if (isSelected) {
                    col.classList.add('highlighted');
                    const bullRect = charWrap.getBoundingClientRect();
                    const containerRect = bubbleContainer.getBoundingClientRect();
                    const clipBottom = containerRect.bottom - (bullRect.top + bullRect.height / 2);
                    bubbleContainer.style.setProperty('--clip-bottom', `${clipBottom}px`);
                } else {
                    col.classList.remove('highlighted');
                }

                const existingBubbles = bubbleContainer.querySelectorAll('.bubble');
                const bubbleColor = laneColors[targetLaneConfig?.id] || '#ffffff';
                
                existingBubbles.forEach((b, i) => {
                    b.classList.add('flying-out'); 
                    if (isSelected) {
                        const fallTime = 200 + (i * 100);
                        
                        setTimeout(() => {
                            b.classList.add('glowing');
                            b.style.transition = 'transform 0.4s ease-in, box-shadow 0.15s';
                            b.style.transform = 'translateX(-50%) translateY(50cqw)';
                        }, i * 50);

                        setTimeout(() => {
                            const multiplier = parseFloat(b.innerText);
                            const winChance = 0.96 / multiplier; 
                            const roll = Math.random();
                            const isWin = roll < winChance;
                            const winAmount = isWin ? (currentBet * multiplier) : 0;
                            
                            if (isWin) {
                                totalRoundWin += winAmount;
                                currentBalance += winAmount;
                                updateBalanceDisplay(winAmount); 
                                showResultText('WIN', winAmount); 
                                
                                b.classList.add('bubble-hit-win');
                                triggerBullWinFlash();
                            } else {
                                b.style.opacity = '0.5';
                                b.style.filter = 'grayscale(1)';
                            }

                            if(!charWrap.classList.contains('bull-hit-active')) {
                                 charWrap.style.setProperty('--bull-scale', '1.08');
                                 charWrap.style.filter = `drop-shadow(0 0 3cqw ${bubbleColor}) brightness(1.3)`;
                            }
                            
                            setTimeout(() => {
                                charWrap.style.setProperty('--bull-scale', '1');
                                if(!charWrap.classList.contains('bull-hit-active')) {
                                     charWrap.style.filter = 'drop-shadow(0 0.4cqw 0.4cqw rgba(0,0,0,0.3))';
                                }
                            }, 80);
                        }, fallTime); 

                    } else {
                        b.style.filter = 'brightness(0.4)';
                        setTimeout(() => {
                            b.style.transition = 'transform 0.4s ease-in';
                            b.style.transform = 'translateX(-50%) translateY(100vh)';
                        }, i * 30);
                    }
                });
                
                logicalIndex++;
            });
            
            setTimeout(() => {
                if (oldMega) oldMega.remove();
                document.querySelectorAll('.bubble.flying-out').forEach(b => b.remove());
                spawnGrid(true, true);
                
                setTimeout(() => {
                    charWrap.classList.remove('bull-hit-active');
                }, 200);
                
            }, 800);  

            setTimeout(() => {
                charWrap.style.filter = 'drop-shadow(0 0.4cqw 0.4cqw rgba(0,0,0,0.3))';
                charWrap.classList.remove('absorbing');
                gameFrame.classList.remove('hyperspace');
                moveBullToCenter();
                
                document.querySelector('.lanes-grid').classList.remove('focus-mode');
                dimOverlay.classList.remove('active');
                document.querySelectorAll('.lane-col').forEach(c => c.classList.remove('highlighted'));
                
                currentKm += 100;
                updateKmDisplay();
                isAnimating = false;
            }, 1000); 
        }

        function playMegaBlockSequence(targetLaneIndex) {
            const blockCenterIndex = (currentMegaBlock.side === 'left') ? 1 : 4;
            const isPulsar = currentMegaBlock.type === 3;
            const isMultiplierPulsar = currentMegaBlock.type === 4;
            
            currentBalance -= currentBet;
            
            moveBull(blockCenterIndex); 

            setTimeout(() => {
                charWrap.classList.add('absorbing');
                gameFrame.classList.add('hyperspace');
                activateSpeedLines();

                const blockItem = document.querySelector('.mega-block-item');
                
                if (isPulsar || isMultiplierPulsar) {
                     if(isMultiplierPulsar) {
                         shockwaveEl.style.background = 'radial-gradient(circle, rgba(255,243,224,1) 0%, rgba(255,152,0,0.8) 40%, rgba(230,81,0,0) 70%)';
                     } else {
                         shockwaveEl.style.background = ''; 
                     }
                     
                     shockwaveEl.classList.add('active');
                     setTimeout(() => shockwaveEl.classList.remove('active'), 1000);
                     
                     const allBubbles = document.querySelectorAll('.bubble:not(.mega-bubble)');
                     const bubbleList = Array.from(allBubbles);
                     const shuffledBubbles = bubbleList.sort(() => 0.5 - Math.random());
                     
                     let delayBeforeExplode = 300; 

                     if (isMultiplierPulsar) {
                         delayBeforeExplode = 600; 
                         shuffledBubbles.forEach(b => {
                             b.innerText = '2x'; 
                             b.classList.add('doubled'); 
                             b.classList.add('type-x2-converted'); 
                         });
                     }
                     
                     setTimeout(() => {
                         shuffledBubbles.forEach((b, i) => {
                             const multiText = b.innerText.replace('x','');
                             const multiplier = parseFloat(multiText);
                             
                             const winChance = 0.96 / multiplier;
                             const isWin = Math.random() < winChance;
                             
                             if (isWin) {
                                 const winAmt = currentBet * multiplier;
                                 currentBalance += winAmt;
                                 updateBalanceDisplay(winAmt); 
                                 
                                 setTimeout(() => {
                                     b.classList.add('exploded-win');
                                     showResultText('WIN', winAmt); 
                                     triggerBullWinFlash(); 
                                 }, Math.random() * 200); 
                             } else {
                                 setTimeout(() => {
                                     b.classList.add('exploded-loss');
                                 }, Math.random() * 200);
                             }
                         });
                         
                     }, delayBeforeExplode); 
                     
                     setTimeout(() => {
                         if(blockItem) {
                             blockItem.style.transition = 'transform 0.4s ease-in, opacity 0.3s';
                             blockItem.style.transform = 'scale(0.1)';
                             blockItem.style.opacity = '0';
                         }
                         
                         document.querySelectorAll('.bubble').forEach(b => {
                             b.classList.add('flying-out');
                             b.style.transition = 'transform 0.4s ease-in, opacity 0.3s';
                             b.style.transform = 'translateY(100vh)';
                             b.style.opacity = '0';
                         });
                         
                         setTimeout(() => {
                             if(blockItem) blockItem.remove();
                             document.querySelectorAll('.bubble').forEach(b => b.remove());
                             spawnGrid(true, true);
                             
                             charWrap.classList.remove('absorbing');
                             gameFrame.classList.remove('hyperspace');
                             moveBullToCenter();
                             
                             charWrap.classList.remove('bull-hit-active');
                             isAnimating = false;
                         }, 400);

                     }, delayBeforeExplode + 600); 

                } else {
                    if (blockItem) {
                        const ring = blockItem.querySelector('.mega-ring');
                        const megaBubbles = blockItem.querySelectorAll('.mega-bubble');
                        const bubbleArray = Array.from(megaBubbles);
                        const shuffled = bubbleArray.sort(() => 0.5 - Math.random());
                        const betPerBubble = currentBet / 9;
                        
                        shuffled.forEach((mb, i) => {
                            setTimeout(() => {
                                const multiText = mb.innerText.replace('x','');
                                const multiplier = parseFloat(multiText);
                                
                                let isWin = false;
                                if (currentMegaBlock.type === 1) isWin = Math.random() < 0.15; 
                                else isWin = Math.random() < 0.12; 

                                if (isWin) {
                                    const winAmt = betPerBubble * multiplier;
                                    mb.classList.add('win-state');
                                    currentBalance += winAmt;
                                    updateBalanceDisplay(winAmt); 
                                    showResultText('WIN', winAmt); 
                                    triggerBullWinFlash(); 
                                } else {
                                    mb.classList.add('lose-state');
                                }
                                charWrap.style.setProperty('--bull-scale', '1.05');
                                setTimeout(() => charWrap.style.setProperty('--bull-scale', '1'), 50);
                            }, i * 60); 
                        });
                        
                        setTimeout(() => {
                            blockItem.style.transition = 'transform 0.4s ease-in, opacity 0.3s';
                            blockItem.style.transform = 'translateY(100vh) scale(0.5)';
                            blockItem.style.opacity = '0';
                            
                            document.querySelectorAll('.bubble').forEach(b => {
                                b.classList.add('flying-out');
                                b.style.transition = 'transform 0.4s ease-in';
                                b.style.transform = 'translateX(-50%) translateY(100vh)';
                            });
                            
                            setTimeout(() => {
                                blockItem.remove();
                                document.querySelectorAll('.bubble.flying-out').forEach(b => b.remove());
                                spawnGrid(true, true);
                                
                                charWrap.classList.remove('absorbing');
                                gameFrame.classList.remove('hyperspace');
                                moveBullToCenter();
                                
                                charWrap.classList.remove('bull-hit-active'); 
                                isAnimating = false;
                            }, 400);

                        }, megaBubbles.length * 60 + 800);
                    }
                }
            }, 400); 
        }

        // --- NEW SINGLETON SHOW RESULT TEXT ---
        function showResultText(type, amount) {
            if (type !== 'WIN') return; 

            // If fading out, reset (capture it back)
            if (activeWinTextEl && activeWinTextEl.classList.contains('fading-out')) {
                activeWinTextEl.classList.remove('fading-out');
                activeWinTextEl.style.transition = 'transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275)'; // Restore pop transition
                activeWinTextEl.style.opacity = '1';
                // Note: might need force reflow or just let the next frame handle it
            }

            // If we already have a win text visible, update it
            if (activeWinTextEl) {
                activeWinAmount += amount;
                
                // Re-trigger visual pop
                activeWinTextEl.classList.remove('pop');
                void activeWinTextEl.offsetWidth; 
                activeWinTextEl.classList.add('pop');
                
                // Reset timer
                if(activeWinTimer) clearTimeout(activeWinTimer);
                activeWinTimer = setTimeout(fadeOutWinText, 600); // Short wait before fade
                
            } else {
                // Create new
                activeWinAmount = amount;
                activeWinDisplay = 0; // Start rolling from 0
                
                activeWinTextEl = document.createElement('div');
                activeWinTextEl.className = 'center-win-text';
                // Initial text (will be updated by loop immediately)
                activeWinTextEl.innerText = `WIN +$0.00`; 
                gameFrame.appendChild(activeWinTextEl);
                
                // Set initial removal timer
                activeWinTimer = setTimeout(fadeOutWinText, 600);
            }
        }

        function fadeOutWinText() {
            if(!activeWinTextEl) return;
            
            // Add class for CSS transition
            activeWinTextEl.classList.add('fading-out');
            
            // Remove from DOM after transition completes
            setTimeout(() => {
                if(activeWinTextEl && activeWinTextEl.classList.contains('fading-out')) {
                    activeWinTextEl.remove();
                    activeWinTextEl = null;
                    activeWinAmount = 0;
                    activeWinDisplay = 0;
                }
            }, 400); // Match CSS transition time
        }

        function activateSpeedLines() {
            const container = document.getElementById('speed-lines');
            if(!container) return;
            container.innerHTML = ''; 
            container.classList.add('active');
            for(let i=0; i<40; i++) {
                const line = document.createElement('div');
                line.className = 'speed-line';
                line.style.left = Math.random() * 100 + '%';
                line.style.height = (30 + Math.random() * 50) + 'vh';
                line.style.width = (1 + Math.random() * 2) + 'px';
                line.style.opacity = 0.5 + Math.random() * 0.5;
                line.style.animation = `warpSpeed ${0.15 + Math.random() * 0.2}s linear forwards`;
                line.style.animationDelay = Math.random() * 0.1 + 's';
                container.appendChild(line);
            }
            setTimeout(() => { container.classList.remove('active'); }, 600);
        }

        function moveBull(index) {
            const targets = document.querySelectorAll('.lane-col');
            let targetEl = null;
            targets.forEach(el => { if(parseInt(el.dataset.index) === index) targetEl = el; });
            if (!targetEl) return;
            const frameRect = document.getElementById('game-frame').getBoundingClientRect();
            const targetRect = targetEl.getBoundingClientRect();
            const relativeX = (targetRect.left + targetRect.width / 2) - frameRect.left;
            charWrap.style.left = `${relativeX}px`;
        }

        function moveBullToCenter() {
            charWrap.style.left = '50%';
        }

        function updateBet(add, mul) {
            if (mul) currentBet *= mul;
            else currentBet += add;
            if (currentBet < 1) currentBet = 1;
            document.getElementById('bet-display').innerText = `$${currentBet.toFixed(2)}`;
        }
        
        document.getElementById('refresh-btn').onclick = () => {
             if (isAnimating) return;
             const btn = document.getElementById('refresh-btn');
             btn.style.transform = "scale(0.95)";
             setTimeout(() => btn.style.transform = "scale(1)", 100);
             if(tooltipEl) tooltipEl.classList.remove('active');
             
             regenerateBoard();
        };

        window.onload = init;
        window.onresize = () => { 
            if(isAnimating) requestAnimationFrame(() => moveBull(selectedLaneIndex));
            else moveBullToCenter();
        };

    </script>
</body>
</html>